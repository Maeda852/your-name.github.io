<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>出社フォーム＋Googleフォーム事前入力対応</title>
  <style>
    body { font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Segoe UI", Roboto, "Noto Sans JP"; padding:16px; max-width:640px; margin:auto; }
    h1 { font-size:20px; margin-bottom:8px; }
    input, button { font-size:16px; padding:10px; margin-top:8px; width:100%; box-sizing:border-box; }
    button { cursor:pointer; }
    #result { margin-top:12px; font-size:18px; font-weight:600; }
    .note { color:#666; font-size:13px; margin-top:8px; }
  </style>
</head>
<body>
  <h1>出社フォーム（氏名入力）</h1>
  <p>氏名を入力してください（候補が出ます）</p>

  <input list="namelist" id="nameInput" placeholder="例：山田太郎" autocomplete="off" />
  <datalist id="namelist"></datalist>

  <div id="idcardContainer" style="margin-top:8px; display:none;">
    <label>IDカード番号（任意入力可）:</label>
    <input type="text" id="idcardInput" placeholder="IDカード番号" />
  </div>

  <button id="submitBtn">部署確認・次へ</button>

  <div id="result"></div>
  <div class="note">※ 名簿はスプレッドシートで毎日更新してください。</div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpGDiZD4OrEiEzIh4DMRN0eFbHkBGZSnxewenjI-jnTstC1U07dQ0mfvNBM5KW9M88tL5fqQ8fyLWy/pubhtml"; 
    const googleFormBaseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSfCHO8Ic_LePLxIXwTunyZGOh6WH2heDERT0ycrCDUUO0mUBg/viewform?usp=pp_url&entry.1288388977="; 
    // googleFormBaseUrl の末尾は氏名用entryパラメータまで含めておく
    // 例: "https://docs.google.com/forms/d/e/FORM_ID/viewform?usp=pp_url&entry.123456="

    // 各Googleフォーム欄のentry番号
    const entryIdCard = "352252719";   // IDカード番号欄
    const entryDepartment = "1018926610"; // 部署欄

    let employees = [];

    function normalizeName(s){ return (s||"").trim().toLowerCase(); }

    function loadCsv(){
      fetch(csvUrl)
        .then(r=>r.text())
        .then(text=>{
          const parsed = Papa.parse(text,{header:true, skipEmptyLines:true});
          employees = parsed.data.map(row=>({
            name: row.name ? row.name.trim() : "",
            department: row.department ? row.department.trim() : "",
            idcard: row.idcard ? row.idcard.trim() : ""
          })).filter(e=>e.name);

          const seen = new Set();
          const dl = document.getElementById("namelist");
          dl.innerHTML="";
          employees.forEach(e=>{
            if(!seen.has(e.name)){
              seen.add(e.name);
              const opt = document.createElement("option");
              opt.value = e.name;
              dl.appendChild(opt);
            }
          });
        })
        .catch(err=>{
          document.getElementById("result").textContent="データ読み込みエラー";
          console.error(err);
        });
    }

    function searchDept(){
      const raw = document.getElementById("nameInput").value || "";
      const nameNormalized = normalizeName(raw);
      if(!nameNormalized){
        document.getElementById("result").textContent="氏名を入力してください";
        document.getElementById("idcardContainer").style.display="none";
        return null;
      }

      const matches = employees.filter(e=>normalizeName(e.name)===nameNormalized);
      if(matches.length===0){
        document.getElementById("result").textContent="該当する氏名が見つかりません";
        document.getElementById("idcardContainer").style.display="none";
        return null;
      }

      let emp = matches[0];
      const deps = matches.length>1 ? [...new Set(matches.map(m=>m.department))].join(" / ") : emp.department;
      document.getElementById("result").textContent = `${emp.name} さんの配置部署: 【${deps}】`;

      const idInput = document.getElementById("idcardInput");
      if(emp.idcard){ 
        idInput.value = emp.idcard; 
        idInput.readOnly = true;
      } else {
        idInput.value = "";
        idInput.readOnly = false;
      }
      document.getElementById("idcardContainer").style.display="block";

      return emp;
    }

    function goToGoogleForm(){
      const emp = searchDept();
      if(!emp) return;

      let url = googleFormBaseUrl + encodeURIComponent(emp.name);

      const idValue = document.getElementById("idcardInput").value.trim();
      if(idValue){
        url += "&entry." + entryIdCard + "=" + encodeURIComponent(idValue);
      }

      if(emp.department){
        url += "&entry." + entryDepartment + "=" + encodeURIComponent(emp.department);
      }

      window.location.href = url;
    }

    document.getElementById("submitBtn").addEventListener("click", goToGoogleForm);
    document.getElementById("nameInput").addEventListener("keypress", e=>{
      if(e.key==="Enter"){ e.preventDefault(); goToGoogleForm(); }
    });

    loadCsv();
  </script>
</body>
</html>
